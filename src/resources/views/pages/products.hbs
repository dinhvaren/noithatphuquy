<style>
    body {
        background-color: #f8f9fa;
    }

    .section-title {
        font-size: 1.75rem;
        font-weight: 600;
        color: #1a1a1a;
    }

    .filter-sidebar {
        background: white;
        border-radius: 12px;
        position: sticky;
        top: 20px;
        height: fit-content;
    }

    .product-card {
        background: white;
        border-radius: 12px;
        transition: all 0.3s ease;
        height: 100%;
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .product-image {
        height: 200px;
        object-fit: cover;
        border-radius: 12px 12px 0 0;
    }

    .price {
        color: #C19977;
        font-weight: 600;
    }

    .discount-badge {
        position: absolute;
        top: 0;
        left: 0;
        background: #dc2626;
        color: white;
        padding: 5px 15px;
        font-size: 0.875rem;
        font-weight: bold;
        clip-path: polygon(0 0, 100% 0, 85% 100%, 0 100%);
        z-index: 1;
        border-radius: 12px 0 0 0;
    }

    .wishlist-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        z-index: 2;
    }

    .wishlist-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .wishlist-btn.active {
        background: #fee2e2;
    }

    .wishlist-btn.active i {
        color: #dc2626;
    }

    .wishlist-btn i {
        font-size: 16px;
        transition: color 0.3s ease;
    }

    .rating-stars {
        color: #fbbf24;
    }

    .category-badge {
        background: #e5e7eb;
        color: #4b5563;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
    }

    .filter-group {
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }

    /* Tùy chỉnh thanh range input */
    .form-range::-webkit-slider-thumb {
        background: #C19977;
    }

    .form-range::-moz-range-thumb {
        background: #C19977;
    }

    .form-range::-webkit-slider-runnable-track {
        background: #e5e7eb;
    }

    .form-range::-moz-range-track {
        background: #e5e7eb;
    }

    .form-range:focus::-webkit-slider-thumb {
        box-shadow: 0 0 0 1px #fff, 0 0 0 0.25rem rgba(193, 153, 119, 0.25);
    }

    .form-range:focus::-moz-range-thumb {
        box-shadow: 0 0 0 1px #fff, 0 0 0 0.25rem rgba(193, 153, 119, 0.25);
    }

    .color-option {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        position: relative;
    }

    .color-option.selected::after {
        content: '';
        position: absolute;
        inset: -3px;
        border: 2px solid #C19977;
        border-radius: 50%;
    }

    .sort-btn {
        background: white;
        border: 1px solid #e5e7eb;
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .sort-btn:hover {
        background: #f3f4f6;
    }

    .cart-btn {
        background: #C19977;
        color: white;
        border: none;
        transition: all 0.2s;
    }

    .cart-btn:hover {
        background: #9b7b5f;
        transform: translateY(-2px);
    }

    .pagination .page-link {
        color: #C19977;
        border-color: #e5e7eb;
        margin: 0 3px;
        border-radius: 8px;
        padding: 8px 16px;
    }

    .pagination .page-link:hover {
        background-color: #f3f4f6;
        color: #9b7b5f;
        border-color: #e5e7eb;
    }

    .pagination .page-item.active .page-link {
        background-color: #C19977;
        border-color: #C19977;
        color: white;
    }

    .pagination .page-item.disabled .page-link {
        color: #6c757d;
        pointer-events: none;
        background-color: #fff;
        border-color: #e5e7eb;
    }

    /* Thêm style cho product link */
    .product-link {
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .product-link:hover {
        text-decoration: none;
        color: inherit;
    }
</style>
{{#if user}}
{{> header_2}}
{{else}}
{{> header}}
{{>modalLogin}}
{{>modalSignup}}
{{/if}}

<div class="container py-5">
    <!-- Top Bar -->
        <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="section-title mb-0">Sản Phẩm</h2>
        <div class="d-flex gap-2 align-items-center">
            <span class="text-muted">Sắp xếp theo:</span>
            <form method="GET" action="/products" class="mb-0">
            <select class="form-select" name="sort" onchange="this.form.submit()">
                <option value="">Mới nhất</option>
                <option value="price_asc" {{#if (eq ../query.sort "price_asc")}}selected{{/if}}>Giá tăng dần</option>
                <option value="price_desc" {{#if (eq ../query.sort "price_desc")}}selected{{/if}}>Giá giảm dần</option>
            </select>
            </form>
        </div>
        </div>


    <div class="row g-4">
        <!-- Filters Sidebar -->
        <div class="col-lg-3">
            <div class="filter-sidebar p-4 shadow-sm">
            <form method="GET" action="/products">
                <div class="filter-group" id="accordionCategories">
                    <h6 class="mb-3">Danh Mục</h6>
                    {{#each categories}}
                        <!-- Danh mục cha -->
                        <div class="mb-2">
                            <div 
                                class="fw-bold d-flex justify-content-between align-items-center text-dark"
                                data-bs-toggle="collapse"
                                data-bs-target="#cat-children-{{this._id}}"
                                aria-expanded="false"
                                aria-controls="cat-children-{{this._id}}"
                                style="cursor: pointer;">
                                {{this.name}}
                                <i class="bi bi-chevron-down"></i>
                            </div>
                        </div>

                        <!-- Danh mục con -->
                        <div class="collapse ms-3" id="cat-children-{{this._id}}" data-bs-parent="#accordionCategories">
                            {{#if this.children}}
                                {{#each this.children}}
                                <div class="form-check mb-2">
                                    <input 
                                        class="form-check-input" 
                                        type="checkbox" 
                                        id="cat-{{this._id}}" 
                                        name="category[]" 
                                        value="{{this._id}}"
                                        {{#if (isChecked ../../query.category this._id)}}checked{{/if}}>
                                    <label class="form-check-label" for="cat-{{this._id}}">
                                        {{this.name}}
                                    </label>
                                </div>
                                {{/each}}
                            {{/if}}
                        </div>
                    {{/each}}
                </div>

                <div class="filter-group">
                <h6 class="mb-3">Khoảng Giá</h6>
                <input 
                    type="range" 
                    class="form-range" 
                    id="priceRange" 
                    min="0" 
                    max="50000000" 
                    step="100000"
                    value="{{query.maxPrice}}"
                >
                <input type="hidden" name="maxPrice" id="maxPriceInput" value="{{query.maxPrice}}">
                <div class="d-flex justify-content-between">
                    <span class="text-muted" id="currentPrice">
                    {{#if query.maxPrice}}
                        {{formatCurrency query.maxPrice}}
                    {{else}}
                        0đ
                    {{/if}}
                    </span>
                    <span class="text-muted">50.000.000đ</span>
                </div>
                </div>

                <script>
                const priceRange = document.getElementById("priceRange");
                const currentPrice = document.getElementById("currentPrice");
                const maxPriceInput = document.getElementById("maxPriceInput");

                priceRange.addEventListener("input", () => {
                    currentPrice.textContent = new Intl.NumberFormat("vi-VN").format(priceRange.value) + "đ";
                    maxPriceInput.value = priceRange.value;
                });
                </script>

                <div class="filter-group">
                    <h6 class="mb-3">Màu Sắc</h6>
                    <div class="d-flex gap-2">
                        <div class="color-option selected" style="background: #000000;"></div>
                        <div class="color-option" style="background: #964B00;"></div>
                        <div class="color-option" style="background: #FFFFFF;"></div>
                        <div class="color-option" style="background: #808080;"></div>
                    </div>
                </div>

                <div class="filter-group">
                <h6 class="mb-3">Đánh Giá</h6>

                <div class="form-check mb-2">
                    <input 
                    class="form-check-input" 
                    type="radio" 
                    name="rating" 
                    id="rating4" 
                    value="4"
                    {{#if (isEqual query.rating "4")}}checked{{/if}}>
                    <label class="form-check-label" for="rating4">
                    <i class="bi bi-star-fill text-warning"></i> 4 sao trở lên
                    </label>
                </div>

                <div class="form-check mb-2">
                    <input 
                    class="form-check-input" 
                    type="radio" 
                    name="rating" 
                    id="rating3" 
                    value="3"
                    {{#if (isEqual query.rating "3")}}checked{{/if}}>
                    <label class="form-check-label" for="rating3">
                    <i class="bi bi-star-fill text-warning"></i> 3 sao trở lên
                    </label>
                </div>
                </div>


                <button type="submit" class="btn btn-outline-primary w-100">Lọc</button>
                </form>
            </div>
        </div>

        <!-- Product Grid -->
        <div class="col-lg-9">
            <div class="row g-4">
                <!-- Product Card 1 -->
{{#each products}}
                <div class="col-md-4">
                    <div class="product-card shadow-sm">
                        <div class="position-relative">
                            <a href="/products/{{this.slug}}" class="product-link">
                                <img src="{{this.images.[0]}}" class="product-image w-100" alt="{{this.name}}">
                                {{#if this.salePrice}}
                                <span class="discount-badge">-{{calculateDiscountPercentage this.price this.salePrice}}%</span>
                                {{/if}}
                            </a>
                            <button class="wishlist-btn" onclick="event.preventDefault(); event.stopPropagation();">
                                <i class="bi bi-heart"></i>
                            </button>
                        </div>
                        <a href="/product-details/{{this.slug}}" class="product-link">
                            <div class="p-3">
                                <span class="category-badge mb-2 d-inline-block">{{this.categoryId.name}}</span>
                                <h6 class="mb-1">{{this.name}}</h6>
                                <div class="rating-stars mb-2">
                                {{#if this.rating}}
                                    {{#each (range 1 5)}}
                                        {{#ifCond this '<=' ../rating}}
                                        <i class="bi bi-star-fill text-warning"></i>
                                    {{else}}
                                        <i class="bi bi-star text-warning"></i>
                                        {{/ifCond}}
                                    {{/each}}
                                    <span class="text-muted ms-2">({{../rating}})</span>
                               {{/if}}
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex flex-column">
                                    {{#if this.salePrice}}
                                        <span class="text-decoration-line-through text-muted small">
                                        {{formatCurrency this.price}}đ
                                        </span>
                                        <span class="price">{{formatCurrency this.salePrice}}</span>
                                    {{else}}
                                        <span class="price">{{formatCurrency this.price}}</span>
                                    {{/if}}
                                    </div>
                             </a>
                                    <button 
                                        type="button" 
                                        class="btn cart-btn add-to-cart" 
                                        data-id="{{this._id}}">
                                        <i class="bi bi-cart-plus"></i>
                                    </button>
                                </div>
                            </div>
                    </div>
                </div>
                    {{/each}}
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-center mt-5">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <li class="page-item" id="prevPage">
                    <a class="page-link" href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="page-item active"><a class="page-link" href="#" data-page="1">1</a></li>
                <li class="page-item"><a class="page-link" href="#" data-page="2">2</a></li>
                <li class="page-item" id="nextPage">
                    <a class="page-link" href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>
{{>slideBar}}
{{> footer}}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Xử lý wishlist buttons
        const wishlistBtns = document.querySelectorAll('.wishlist-btn');
        wishlistBtns.forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                
                this.classList.toggle('active');
                const icon = this.querySelector('i');
                if (this.classList.contains('active')) {
                    icon.classList.remove('bi-heart');
                    icon.classList.add('bi-heart-fill');
                } else {
                    icon.classList.remove('bi-heart-fill');
                    icon.classList.add('bi-heart');
                }
            });
        });

        // Xử lý price range
        const priceRange = document.getElementById('priceRange');
        const currentPrice = document.getElementById('currentPrice');

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN').format(price) + 'đ';
        }

        priceRange.addEventListener('input', function () {
            currentPrice.textContent = formatPrice(this.value);
        });

        // Xử lý phân trang
        const productsPerPage = 12;
        const productGrid = document.querySelector('.row.g-4 .col-lg-9 .row');
        const products = Array.from(productGrid.children);
        let currentPage = 1;

        // Ẩn tất cả sản phẩm ban đầu
        products.forEach((product, index) => {
            if (index >= productsPerPage) {
                product.style.display = 'none';
            }
        });

        // Xử lý click vào số trang
        document.querySelectorAll('.page-link[data-page]').forEach(pageLink => {
            pageLink.addEventListener('click', function(e) {
                e.preventDefault();
                const pageNum = parseInt(this.dataset.page);
                showPage(pageNum);
                
                // Cập nhật trạng thái active
                document.querySelectorAll('.page-item').forEach(item => item.classList.remove('active'));
                this.parentElement.classList.add('active');
                
                // Cập nhật currentPage
                currentPage = pageNum;
                updatePaginationButtons();
            });
        });

        // Xử lý nút Previous
        document.getElementById('prevPage').addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage > 1) {
                showPage(currentPage - 1);
                currentPage--;
                updatePaginationButtons();
                // Cập nhật trạng thái active
                document.querySelectorAll('.page-item').forEach(item => item.classList.remove('active'));
                document.querySelector(`.page-link[data-page="${currentPage}"]`).parentElement.classList.add('active');
            }
        });

        // Xử lý nút Next
        document.getElementById('nextPage').addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage < 2) {
                showPage(currentPage + 1);
                currentPage++;
                updatePaginationButtons();
                // Cập nhật trạng thái active
                document.querySelectorAll('.page-item').forEach(item => item.classList.remove('active'));
                document.querySelector(`.page-link[data-page="${currentPage}"]`).parentElement.classList.add('active');
            }
        });

        function showPage(pageNum) {
            const start = (pageNum - 1) * productsPerPage;
            const end = start + productsPerPage;

            products.forEach((product, index) => {
                if (index >= start && index < end) {
                    product.style.display = '';
                } else {
                    product.style.display = 'none';
                }
            });
        }

        function updatePaginationButtons() {
            document.getElementById('prevPage').classList.toggle('disabled', currentPage === 1);
            document.getElementById('nextPage').classList.toggle('disabled', currentPage === 2);
        }
            
        // Khởi tạo trạng thái ban đầu của các nút
        updatePaginationButtons();
    });
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".add-to-cart").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      e.preventDefault();
      const productId = btn.dataset.id;

      try {
        const res = await fetch("/cart/add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productId, quantity: 1 })
        });

        const data = await res.json();
        if (data.success) {
          // ✅ Cập nhật badge
          document.querySelector(".cart-badge").textContent = data.cart.items.length;

          // ✅ Cập nhật modal cart
          const cartItemsDiv = document.querySelector(".cart-items");
          cartItemsDiv.innerHTML = ""; // clear cũ
          data.cart.items.forEach(item => {
            cartItemsDiv.innerHTML += `
                <div class="cart-item d-flex align-items-center mb-3">
                    <img src="${item.image}" alt="${item.name}" class="rounded" 
                        style="width: 60px; height: 60px; object-fit: cover;" />
                    <div class="ms-3 flex-grow-1">
                    <h6 class="mb-0">${item.name}</h6>
                    <div class="d-flex align-items-center">
                        <small class="text-muted me-2">Số lượng: ${item.quantity}</small>
                        <span class="text-primary">${new Intl.NumberFormat("vi-VN").format(item.price)} đ</span>
                    </div>
                    </div>
                    <form method="POST" action="/cart/remove?_method=DELETE" class="ms-2">
                    <input type="hidden" name="productId" value="${item.productId}" />
                    <button type="submit" class="btn btn-link text-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                    </form>
                </div>
                `;
          });

          // ✅ Tổng tiền
          document.getElementById("cart-total").textContent = 
            new Intl.NumberFormat("vi-VN").format(data.cart.totalAmount) + " đ";

          // ✅ Hiển thị modal ngay sau khi thêm
          const cartModal = new bootstrap.Modal(document.getElementById("cartModal"));
          cartModal.show();
        } else {
          alert(data.message || "❌ Lỗi khi thêm vào giỏ hàng");
        }
      } catch (error) {
        console.error("❌ Fetch error:", error);
        alert("Bạn Cần Đăng Nhập Trước");
      }
    });
  });
});
</script>
